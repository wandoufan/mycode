# Qt应用程序的发布

## 基本概念
在Qt程序功能开发完成之后，需要封装成成一个安装程序，其中包含可执行文件和需要的运行库  
安装程序安装完成之后，在用户计算机上即使没有安装Qt程序也能正常运行  
Qt是跨平台的开发工具，因此应用程序可以在各个平台上发布  
注意：对于要进行发布的应用程序，在编译时应该选择release模式  


## Qt程序的大小
Qt程序调用自己的库，MFC调用本地库，因此一般Qt程序规模要比MFC大很多  
一般来说，跨平台框架开发出来的程序都很大，需要包含很多库文件  
实际测试，一个很简单的Qt项目在Enigma Virtual Box打包之后都有50多M  


## 发布方式
Qt应用程序发布有两种方式：  
1. 静态链接(static linking)  
静态链接是指用Qt编译应用程序时，将Qt的运行库等所需的支持文件全部静态编译到应用程序里，生成一个独立的可执行文件，应用程序发布只需很少的几个文件  
备注：静态链接方式有很多缺点，一般不采用该方式  
1.1 应用程序的可执行文件很大，且生成时间长  
1.2 缺少灵活性，程序更新或Qt更新时需要重新编译再发布  
1.3 不能部署插件  
2. 共享库(shared libraries)  
共享库是指按正常的方式编译生成应用程序，并将应用程序运行所需的共享库一起发布给用户  
2.1 当Qt的运行库有更新时，可以单独更新Qt运行库  
2.2 可以以共享库的形式部署插件，并对插件进行单独更新  


## windeployqt.exe工具
Qt提供了windeployqt.exe作为发布windows程序的工具，位于Qt的编译器目录的bin目录下  
例如：'C:\Qt\5.15.1\msvc2019_64\bin\windeployqt.exe'  
注意：应用程序是由哪个编译器生成的，就要用该编译器目录下的windeployqt.exe  
该工具可以自动为一个应用程序复制其运行所需的各种库文件、插件和翻译文件，生成可发布的目录  


## 在windows平台上发布步骤
1. 将程序用release模式进行编译，然后进入到编译好的目录下找到生成的exe可执行文件  
此时该点击该exe是无法直接运行的，会报错缺少动态链接库  

2. 新建一个目录作为发布目录，将exe可执行文件拷贝到该目录下  
如果exe文件需要改名，可以在此时进行重新命名  

3. 打开cmd，进入到windeployqt.exe所在的目录，然后执行如下命令  
命令执行完成后发布目录中会多出很多相关的dll文件，此时点击该exe就可以直接运行了  
```
windeployqt.exe E:\setup\UGEE_CS03.exe
```
备注：windeployqt.exe不能保证一次将所有依赖文件完全复制，必须要运行测试依赖库的完整性  

4. 使用程序发布制作软件Enigma Virtual Box(或其他软件)对发布目录下所有文件进行打包  
打包完成后发布目录下的exe和dll文件就可以整合成一个单独的exe可执行文件  
先选择上方的文件路径，输入文件路径为发布目录中exe文件的路径，输出路径任意  
再选择左下方的依赖文件或文件夹，注意要把文件夹中exe去掉  
备注：可以用右键-'Add Folder Recursive'把整个发布目录放进来，然后去掉exe程序  
最后选择右下方的打包，之后在输出目录就可以看到exe文件  


## 设置程序图标
1. 基本说明
Qt项目编译后，会在对应的目录下生成一个exe程序，但这个程序的图标是默认的  
可以通过以下设置自己更换程序的图标  
2. 关于ico格式的图标
自己要用的程序图标文件必须转换成.ico格式，不能是.jpg等其他格式的文件  
图标文件格式转换可以使用下面的网站  
```
https://www.bitbug.net/
```
注意：不能直接对文件更改后缀名来转换格式，否则编译时会报错  
```
D:\project\Qt_Test\demo6_SpinBox\123.ico is not in 3.00 format
```
3. 设置步骤
将转换后的.ico图标文件拷贝到项目目录下，和.pro文件同级  
在.pro文件中加上以下内容，之后重新编译即可  
```
RC_ICONS = spinbox.ico
```


## 封装的Qt程序在win7上运行有问题
1. 情况描述
有一个485串口震动传感器，写了一个Qt程序用来读取震动传感器的数据  
读取过程为：发送一次请求指令，接收一次返回数据并解析为震动值，显示在界面上  
2. 本机环境
Win10系统，使用Qt 5.15 + MSVC 2015开发，开发完成之后把Qt程序封装为一个exe程序  
3. 项目现场上位机环境
win7 64位系统，因为部署edas，所以安装了Qt 5.2.1，但没有安装编译器  
4. 问题描述
exe程序在本机上运行完全正常  
拷贝到上位机上后，能够正常打开程序，但发送请求指令后没有收到返回数据，或者返回数据格式不对  
5. 原因分析
想在上位机上部署VS2010编译器调试，但造成了edas无法正常打开，原因未知  
没有办法调试，最终也没有找到原因  
理论上来说，Qt程序跨平台，在其他电脑上也应该运行成功，但这次不是这样  
因此，后面使用Qt做工具程序时，要多在不同的电脑环境上测试  